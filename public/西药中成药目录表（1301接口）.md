# 1301接口对应的西药中成药目录表

## 1. 西药中成药目录表 (drug_catalog)

```sql
-- 西药中成药目录表（1301接口对应，包含97个字段）
CREATE TABLE drug_catalog (
    id BIGSERIAL PRIMARY KEY,
    
    -- 第1-10列：基本信息
    med_list_codg VARCHAR(50) NOT NULL,                 -- 第1列：医疗目录编码
    drug_prodname VARCHAR(500),                         -- 第2列：药品商品名
    generic_codg VARCHAR(50),                           -- 第3列：通用名编号
    drug_genname VARCHAR(500),                          -- 第4列：药品通用名
    chem_name VARCHAR(500),                             -- 第5列：化学名称
    alias_name VARCHAR(500),                            -- 第6列：别名
    eng_name VARCHAR(500),                              -- 第7列：英文名称
    reg_name VARCHAR(500),                              -- 第8列：注册名称
    drug_supervise_code VARCHAR(50),                    -- 第9列：药监本位码
    dosform VARCHAR(20),                                -- 第10列：药品剂型
    
    -- 第11-20列：剂型和类别信息
    dosform_name VARCHAR(100),                          -- 第11列：药品剂型名称
    drug_type VARCHAR(20),                              -- 第12列：药品类别
    drug_type_name VARCHAR(100),                        -- 第13列：药品类别名称
    drug_spec VARCHAR(200),                             -- 第14列：药品规格
    drug_spec_code VARCHAR(50),                         -- 第15列：药品规格代码
    reg_dosform VARCHAR(20),                            -- 第16列：注册剂型
    reg_spec VARCHAR(200),                              -- 第17列：注册规格
    reg_spec_code VARCHAR(50),                          -- 第18列：注册规格代码
    each_dos VARCHAR(100),                              -- 第19列：每次用量
    used_frqu VARCHAR(100),                             -- 第20列：使用频次
    
    -- 第21-30列：药品属性信息
    acid_base VARCHAR(100),                             -- 第21列：酸根盐基
    natl_drug_no VARCHAR(50),                           -- 第22列：国家药品编号
    usage_method VARCHAR(200),                          -- 第23列：用法
    tcm_flag VARCHAR(10),                               -- 第24列：中成药标志
    prod_plac_type VARCHAR(10),                         -- 第25列：生产地类别
    prod_plac_type_name VARCHAR(100),                   -- 第26列：生产地类别名称
    pric_unit_type VARCHAR(10),                         -- 第27列：计价单位类型
    otc_flag VARCHAR(10),                               -- 第28列：非处方药标志
    otc_flag_name VARCHAR(100),                         -- 第29列：非处方药标志名称
    pacmatl VARCHAR(20),                                -- 第30列：包装材质
    
    -- 第31-40列：包装信息
    pacmatl_name VARCHAR(100),                          -- 第31列：包装材质名称
    pacspec VARCHAR(200),                               -- 第32列：包装规格
    pac_quan DECIMAL(10,2),                             -- 第33列：包装数量
    func_indic TEXT,                                    -- 第34列：功能主治
    drug_route VARCHAR(100),                            -- 第35列：给药途径
    drug_instruc TEXT,                                  -- 第36列：说明书
    begndate DATE,                                      -- 第37列：开始日期
    enddate DATE,                                       -- 第38列：结束日期
    min_use_unit VARCHAR(50),                           -- 第39列：最小使用单位
    min_sale_unit VARCHAR(50),                          -- 第40列：最小销售单位
    
    -- 第41-50列：计量单位信息
    min_dosage_unit VARCHAR(50),                        -- 第41列：最小计量单位
    min_pac_quan DECIMAL(10,2),                         -- 第42列：最小包装数量
    min_pac_unit VARCHAR(50),                           -- 第43列：最小包装单位
    min_prep_unit VARCHAR(50),                          -- 第44列：最小制剂单位
    min_pac_unit_name VARCHAR(100),                     -- 第45列：最小包装单位名称
    min_prep_unit_name VARCHAR(100),                    -- 第46列：最小制剂单位名称
    conv_ratio DECIMAL(10,4),                           -- 第47列：转换比
    drug_expy VARCHAR(50),                              -- 第48列：药品有效期
    min_pric_unit VARCHAR(50),                          -- 第49列：最小计价单位
    wubi VARCHAR(100),                                  -- 第50列：五笔助记码
    
    -- 第51-60列：企业和注册信息
    pinyin VARCHAR(100),                                -- 第51列：拼音助记码
    subpac_manuf VARCHAR(200),                          -- 第52列：分包装厂家
    prod_entps_code VARCHAR(50),                        -- 第53列：生产企业编号
    prod_entps_name VARCHAR(200),                       -- 第54列：生产企业名称
    spcl_lmtpric_drug_flag VARCHAR(10),                 -- 第55列：特殊限价药品标志
    spcl_drug_flag VARCHAR(10),                         -- 第56列：特殊药品标志
    lmt_use_range VARCHAR(500),                         -- 第57列：限制使用范围
    lmt_use_flag VARCHAR(10),                           -- 第58列：限制使用标志
    drug_reg_cert_no VARCHAR(100),                      -- 第59列：药品注册证号
    drug_reg_cert_begndate DATE,                        -- 第60列：药品注册证号开始日期
    
    -- 第61-70列：证号和状态信息
    drug_reg_cert_enddate DATE,                         -- 第61列：药品注册证号结束日期
    aprvl_no VARCHAR(100),                              -- 第62列：批准文号
    aprvl_no_begndate DATE,                             -- 第63列：批准文号开始日期
    aprvl_no_enddate DATE,                              -- 第64列：批准文号结束日期
    markt_stas VARCHAR(10),                             -- 第65列：市场状态
    markt_stas_name VARCHAR(100),                       -- 第66列：市场状态名称
    drug_reg_file TEXT,                                 -- 第67列：药品注册批件电子档案
    drug_suppl_file TEXT,                               -- 第68列：药品补充申请批件电子档案
    hilist_memo TEXT,                                   -- 第69列：国家医保药品目录备注
    basic_drug_flag_name VARCHAR(100),                  -- 第70列：基本药物标志名称
    
    -- 第71-80列：医保相关信息
    basic_drug_flag VARCHAR(10),                        -- 第71列：基本药物标志
    vat_adj_drug_flag VARCHAR(10),                      -- 第72列：增值税调整药品标志
    vat_adj_drug_name VARCHAR(100),                     -- 第73列：增值税调整药品名称
    mkt_drug_list VARCHAR(10),                          -- 第74列：上市药品目录集药品
    hilist_nego_drug_flag VARCHAR(10),                  -- 第75列：医保谈判药品标志
    hilist_nego_drug_name VARCHAR(100),                 -- 第76列：医保谈判药品名称
    nhc_drug_code VARCHAR(50),                          -- 第77列：卫健委药品编码
    memo TEXT,                                          -- 第78列：备注
    vali_flag VARCHAR(10),                              -- 第79列：有效标志
    uniq_record_no VARCHAR(100),                        -- 第80列：唯一记录号
    
    -- 第81-90列：数据管理信息
    data_crte_time TIMESTAMP,                           -- 第81列：数据创建时间
    data_updt_time TIMESTAMP,                           -- 第82列：数据更新时间
    ver VARCHAR(50),                                    -- 第83列：版本号
    ver_name VARCHAR(100),                              -- 第84列：版本名称
    chld_drug VARCHAR(10),                              -- 第85列：儿童用药
    comp_name VARCHAR(200),                             -- 第86列：公司名称
    generic_consistency_eval VARCHAR(10),               -- 第87列：仿制药一致性评价药品
    dealer_entps VARCHAR(200),                          -- 第88列：经销企业
    dealer_entps_cont VARCHAR(100),                     -- 第89列：经销企业联系人
    dealer_entps_auth_file TEXT,                        -- 第90列：经销企业授权书电子档案
    
    -- 第91-97列：医保目录信息
    hilist_dosform VARCHAR(100),                        -- 第91列：国家医保药品目录剂型
    hilist_ab_flag VARCHAR(10),                         -- 第92列：国家医保药品目录甲乙类标识
    mkt_auth_holder VARCHAR(200),                       -- 第93列：上市许可证持有人
    down_flag VARCHAR(10),                              -- 第94列：下发标志
    trans_data_id VARCHAR(100),                         -- 第95列：传输数据ID
    efft_time TIMESTAMP,                                -- 第96列：生效时间
    expr_time TIMESTAMP,                                -- 第97列：失效时间
    
    -- 同步相关字段
    sync_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,      -- 同步时间
    data_version VARCHAR(50),                           -- 数据版本号
    
    -- 审计字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建主要索引
CREATE UNIQUE INDEX idx_drug_catalog_med_list_codg ON drug_catalog(med_list_codg);
CREATE INDEX idx_drug_catalog_drug_prodname ON drug_catalog(drug_prodname);
CREATE INDEX idx_drug_catalog_drug_genname ON drug_catalog(drug_genname);
CREATE INDEX idx_drug_catalog_generic_codg ON drug_catalog(generic_codg);
CREATE INDEX idx_drug_catalog_drug_supervise_code ON drug_catalog(drug_supervise_code);
CREATE INDEX idx_drug_catalog_natl_drug_no ON drug_catalog(natl_drug_no);
CREATE INDEX idx_drug_catalog_prod_entps_code ON drug_catalog(prod_entps_code);
CREATE INDEX idx_drug_catalog_prod_entps_name ON drug_catalog(prod_entps_name);
CREATE INDEX idx_drug_catalog_drug_type ON drug_catalog(drug_type);
CREATE INDEX idx_drug_catalog_dosform ON drug_catalog(dosform);
CREATE INDEX idx_drug_catalog_tcm_flag ON drug_catalog(tcm_flag);
CREATE INDEX idx_drug_catalog_vali_flag ON drug_catalog(vali_flag);
CREATE INDEX idx_drug_catalog_basic_drug_flag ON drug_catalog(basic_drug_flag);
CREATE INDEX idx_drug_catalog_hilist_ab_flag ON drug_catalog(hilist_ab_flag);
CREATE INDEX idx_drug_catalog_begndate ON drug_catalog(begndate);
CREATE INDEX idx_drug_catalog_enddate ON drug_catalog(enddate);
CREATE INDEX idx_drug_catalog_sync_time ON drug_catalog(sync_time);
CREATE INDEX idx_drug_catalog_data_version ON drug_catalog(data_version);
CREATE INDEX idx_drug_catalog_uniq_record_no ON drug_catalog(uniq_record_no);

-- 创建搜索索引
CREATE INDEX idx_drug_catalog_wubi ON drug_catalog(wubi);
CREATE INDEX idx_drug_catalog_pinyin ON drug_catalog(pinyin);
CREATE INDEX idx_drug_catalog_prodname_search ON drug_catalog USING gin(to_tsvector('simple', drug_prodname));
CREATE INDEX idx_drug_catalog_genname_search ON drug_catalog USING gin(to_tsvector('simple', drug_genname));

-- 创建复合索引
CREATE INDEX idx_drug_catalog_type_flag ON drug_catalog(drug_type, vali_flag);
CREATE INDEX idx_drug_catalog_dosform_spec ON drug_catalog(dosform, drug_spec);
CREATE INDEX idx_drug_catalog_entps_prod ON drug_catalog(prod_entps_code, drug_prodname);
```

## 2. 文件下载记录表

```sql
-- 文件下载记录表（记录1301接口的文件下载信息）
CREATE TABLE drug_catalog_download_log (
    id BIGSERIAL PRIMARY KEY,
    
    -- 接口返回的4个字段
    file_qury_no VARCHAR(40) NOT NULL,                  -- 文件查询号
    filename VARCHAR(100) NOT NULL,                     -- 文件名
    dld_end_time DATE NOT NULL,                         -- 下载截止日期
    data_cnt INTEGER,                                   -- 数据量
    
    -- 下载状态
    download_status VARCHAR(20) DEFAULT 'pending',      -- pending/downloading/completed/failed
    download_start_time TIMESTAMP,                      -- 开始下载时间
    download_end_time TIMESTAMP,                        -- 完成下载时间
    processed_count INTEGER DEFAULT 0,                  -- 已处理记录数
    error_message TEXT,                                 -- 错误信息
    
    -- 版本信息
    request_version VARCHAR(20),                        -- 请求版本号
    response_version VARCHAR(20),                       -- 响应版本号
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_drug_catalog_download_log_file_qury_no ON drug_catalog_download_log(file_qury_no);
CREATE INDEX idx_drug_catalog_download_log_filename ON drug_catalog_download_log(filename);
CREATE INDEX idx_drug_catalog_download_log_dld_end_time ON drug_catalog_download_log(dld_end_time);
CREATE INDEX idx_drug_catalog_download_log_download_status ON drug_catalog_download_log(download_status);
CREATE INDEX idx_drug_catalog_download_log_request_version ON drug_catalog_download_log(request_version);
```

## 3. 数据同步控制表

```sql
-- 西药中成药目录同步控制表
CREATE TABLE drug_catalog_sync_control (
    id SERIAL PRIMARY KEY,
    sync_type VARCHAR(20) NOT NULL DEFAULT 'incremental', -- full/incremental
    local_version VARCHAR(20),                           -- 本地版本号
    remote_version VARCHAR(20),                          -- 远程版本号
    last_sync_time TIMESTAMP,                            -- 最后同步时间
    next_sync_time TIMESTAMP,                            -- 下次同步时间
    sync_status VARCHAR(20) DEFAULT 'pending',           -- pending/running/completed/failed
    sync_record_count INTEGER DEFAULT 0,                 -- 同步记录数
    file_qury_no VARCHAR(40),                            -- 当前文件查询号
    error_message TEXT,                                  -- 错误信息
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. 创建更新触发器

```sql
-- 创建更新时间触发器
CREATE TRIGGER update_drug_catalog_updated_at 
    BEFORE UPDATE ON drug_catalog 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_drug_catalog_download_log_updated_at 
    BEFORE UPDATE ON drug_catalog_download_log 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_drug_catalog_sync_control_updated_at 
    BEFORE UPDATE ON drug_catalog_sync_control 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## 5. 使用示例

### 5.1 数据插入示例

```sql
-- 插入药品目录数据
INSERT INTO drug_catalog (
    med_list_codg, drug_prodname, generic_codg, drug_genname, chem_name,
    dosform, dosform_name, drug_type, drug_type_name, drug_spec,
    each_dos, used_frqu, prod_entps_code, prod_entps_name, 
    vali_flag, begndate, enddate, ver, wubi, pinyin
) VALUES (
    'A01010101', '阿司匹林肠溶片', 'GEN001', '阿司匹林', 'Acetylsalicylic acid',
    '11', '片剂', '1', '化学药品', '25mg*100片',
    '25mg', '每日一次', 'ENT001', '某某制药有限公司',
    '1', '2024-01-01', '2025-12-31', 'V2024.1', 'ASLPL', 'ASLPLCR'
);

-- 插入下载记录
INSERT INTO drug_catalog_download_log (
    file_qury_no, filename, dld_end_time, data_cnt, 
    download_status, request_version
) VALUES (
    'FILE20250101001', 'drug_catalog_20250101.csv', '2025-01-31', 50000,
    'completed', 'V2024.1'
);
```

### 5.2 数据查询示例

```sql
-- 按药品名称查询
SELECT med_list_codg, drug_prodname, drug_genname, drug_spec, 
       prod_entps_name, vali_flag
FROM drug_catalog 
WHERE drug_prodname LIKE '%阿司匹林%' 
AND vali_flag = '1';

-- 按生产企业查询
SELECT med_list_codg, drug_prodname, drug_genname, drug_spec
FROM drug_catalog 
WHERE prod_entps_name LIKE '%某某制药%' 
AND vali_flag = '1'
ORDER BY drug_prodname;

-- 按拼音助记码查询
SELECT med_list_codg, drug_prodname, drug_genname, pinyin
FROM drug_catalog 
WHERE pinyin LIKE 'ASP%' 
AND vali_flag = '1';

-- 按药品类型统计
SELECT drug_type, drug_type_name, COUNT(*) as drug_count
FROM drug_catalog 
WHERE vali_flag = '1'
GROUP BY drug_type, drug_type_name
ORDER BY drug_count DESC;

-- 查询基本药物
SELECT med_list_codg, drug_prodname, drug_genname, basic_drug_flag_name
FROM drug_catalog 
WHERE basic_drug_flag = '1' 
AND vali_flag = '1';

-- 查询医保谈判药品
SELECT med_list_codg, drug_prodname, drug_genname, hilist_nego_drug_name
FROM drug_catalog 
WHERE hilist_nego_drug_flag = '1' 
AND vali_flag = '1';

-- 查询即将失效的药品
SELECT med_list_codg, drug_prodname, drug_genname, enddate
FROM drug_catalog 
WHERE enddate BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '30 days'
AND vali_flag = '1'
ORDER BY enddate;
```

### 5.3 数据更新示例

```sql
-- 更新药品信息
UPDATE drug_catalog 
SET drug_prodname = '阿司匹林肠溶片（新）',
    drug_spec = '25mg*100片/盒',
    data_updt_time = CURRENT_TIMESTAMP,
    sync_time = CURRENT_TIMESTAMP
WHERE med_list_codg = 'A01010101';

-- 批量更新有效标志
UPDATE drug_catalog 
SET vali_flag = '0',
    expr_time = CURRENT_TIMESTAMP
WHERE enddate < CURRENT_DATE;

-- 更新同步状态
UPDATE drug_catalog_sync_control 
SET sync_status = 'completed',
    last_sync_time = CURRENT_TIMESTAMP,
    next_sync_time = CURRENT_TIMESTAMP + INTERVAL '24 hours',
    sync_record_count = 50000,
    remote_version = 'V2024.2';
```

### 5.4 版本控制查询

```sql
-- 获取本地最大版本号（用于1301接口请求）
SELECT COALESCE(MAX(local_version), '0') as max_version
FROM drug_catalog_sync_control;

-- 查询版本变化情况
SELECT ver, ver_name, COUNT(*) as record_count
FROM drug_catalog 
WHERE vali_flag = '1'
GROUP BY ver, ver_name
ORDER BY ver DESC;

-- 查询需要同步的数据
SELECT COUNT(*) as need_sync_count
FROM drug_catalog 
WHERE sync_time < (
    SELECT COALESCE(last_sync_time, '1970-01-01'::timestamp) 
    FROM drug_catalog_sync_control 
    WHERE sync_type = 'incremental'
);
```

## 6. 字段说明

### 6.1 关键字段
- **med_list_codg**：医疗目录编码，主要标识字段
- **drug_prodname**：药品商品名，常用查询字段
- **drug_genname**：药品通用名，标准名称
- **vali_flag**：有效标志，过滤无效数据
- **begndate/enddate**：有效期，时间范围查询

### 6.2 搜索字段
- **wubi**：五笔助记码，支持五笔输入查询
- **pinyin**：拼音助记码，支持拼音输入查询
- **drug_prodname/drug_genname**：支持全文检索

### 6.3 分类字段
- **drug_type**：药品类别，用于分类统计
- **dosform**：药品剂型，用于分类查询
- **basic_drug_flag**：基本药物标志
- **hilist_ab_flag**：医保甲乙类标识

## 7. 数据同步流程

### 7.1 同步准备
1. 获取本地最大版本号
2. 调用1301接口获取文件信息
3. 记录文件下载信息

### 7.2 数据处理
1. 下载CSV文件
2. 解析97个字段数据
3. 批量插入或更新数据库
4. 更新同步状态

### 7.3 数据维护
1. 清理过期数据
2. 更新版本信息
3. 重建索引优化查询

这个表结构完全保留了1301接口定义的97个字段，支持高效的数据存储、查询和同步管理。