# 1201接口对应的医药机构信息表

## 1. 医药机构信息表 (medical_institution_info)

```sql
-- 医药机构信息表（1201接口 - medinsinfo节点）
CREATE TABLE medical_institution_info (
    id BIGSERIAL PRIMARY KEY,
    
    -- 机构基本信息（完全对应接口输出字段）
    fixmedins_code VARCHAR(12) NOT NULL UNIQUE,         -- 定点医药机构编号
    fixmedins_name VARCHAR(200) NOT NULL,               -- 定点医药机构名称
    uscc VARCHAR(50) NOT NULL,                          -- 统一社会信用代码
    fixmedins_type VARCHAR(6) NOT NULL,                 -- 定点医疗服务机构类型
    hosp_lv VARCHAR(6),                                 -- 医院等级
    exp_content VARCHAR(4000),                          -- 扩展字段
    
    -- 同步相关字段
    sync_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,      -- 同步时间
    data_version VARCHAR(50),                           -- 数据版本号
    
    -- 审计字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_medical_institution_info_fixmedins_code ON medical_institution_info(fixmedins_code);
CREATE INDEX idx_medical_institution_info_fixmedins_name ON medical_institution_info(fixmedins_name);
CREATE INDEX idx_medical_institution_info_uscc ON medical_institution_info(uscc);
CREATE INDEX idx_medical_institution_info_fixmedins_type ON medical_institution_info(fixmedins_type);
CREATE INDEX idx_medical_institution_info_hosp_lv ON medical_institution_info(hosp_lv);
CREATE INDEX idx_medical_institution_info_sync_time ON medical_institution_info(sync_time);

-- 为机构名称创建全文检索索引（支持模糊查询）
CREATE INDEX idx_medical_institution_info_name_search 
ON medical_institution_info USING gin(to_tsvector('simple', fixmedins_name));

-- 为机构名称创建模糊查询索引
CREATE INDEX idx_medical_institution_info_name_pattern 
ON medical_institution_info(fixmedins_name varchar_pattern_ops);
```

## 2. 创建更新触发器

```sql
-- 创建更新时间触发器
CREATE TRIGGER update_medical_institution_info_updated_at 
    BEFORE UPDATE ON medical_institution_info 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## 3. 机构信息同步控制表

```sql
-- 机构信息同步控制表
CREATE TABLE medical_institution_sync_control (
    id SERIAL PRIMARY KEY,
    sync_type VARCHAR(20) NOT NULL DEFAULT 'full',      -- full/incremental
    local_version VARCHAR(50),                           -- 本地版本号
    remote_version VARCHAR(50),                          -- 远程版本号
    last_sync_time TIMESTAMP,                            -- 最后同步时间
    next_sync_time TIMESTAMP,                            -- 下次同步时间
    sync_status VARCHAR(20) DEFAULT 'pending',           -- pending/running/completed/failed
    sync_record_count INTEGER DEFAULT 0,                 -- 同步记录数
    error_message TEXT,                                  -- 错误信息
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建更新触发器
CREATE TRIGGER update_medical_institution_sync_control_updated_at 
    BEFORE UPDATE ON medical_institution_sync_control 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## 4. 使用示例

### 4.1 数据插入示例

```sql
-- 插入医院信息
INSERT INTO medical_institution_info (
    fixmedins_code, fixmedins_name, uscc, fixmedins_type, hosp_lv, exp_content
) VALUES (
    'H12345678901', 
    '北京市第一人民医院', 
    '91110000123456789X', 
    '1',           -- 定点医疗机构
    '3',           -- 三级医院
    '{"地址":"北京市朝阳区某某街道123号","电话":"010-12345678"}'
);

-- 插入药店信息
INSERT INTO medical_institution_info (
    fixmedins_code, fixmedins_name, uscc, fixmedins_type, hosp_lv, exp_content
) VALUES (
    'P98765432101', 
    '某某大药房连锁店', 
    '91110000987654321Y', 
    '2',           -- 定点零售药店
    NULL,          -- 药店无等级
    '{"地址":"北京市海淀区某某路456号","营业时间":"8:00-22:00"}'
);
```

### 4.2 数据查询示例

```sql
-- 根据机构编号查询
SELECT * FROM medical_institution_info 
WHERE fixmedins_code = 'H12345678901';

-- 根据机构名称模糊查询（对应接口输入的关键字模糊查询）
SELECT fixmedins_code, fixmedins_name, fixmedins_type, hosp_lv
FROM medical_institution_info 
WHERE fixmedins_name LIKE '%人民医院%';

-- 查询特定类型的机构
SELECT fixmedins_code, fixmedins_name, hosp_lv
FROM medical_institution_info 
WHERE fixmedins_type = '1'  -- 定点医疗机构
ORDER BY fixmedins_name;

-- 查询特定等级的医院
SELECT fixmedins_code, fixmedins_name, fixmedins_type
FROM medical_institution_info 
WHERE hosp_lv = '3'  -- 三级医院
ORDER BY fixmedins_name;

-- 全文检索查询
SELECT fixmedins_code, fixmedins_name, fixmedins_type
FROM medical_institution_info 
WHERE to_tsvector('simple', fixmedins_name) @@ plainto_tsquery('simple', '人民医院');

-- 统计查询
SELECT 
    fixmedins_type,
    COUNT(*) as institution_count,
    COUNT(*) FILTER (WHERE hosp_lv IS NOT NULL) as hospital_count
FROM medical_institution_info 
GROUP BY fixmedins_type;
```

### 4.3 数据更新示例

```sql
-- 更新机构信息
UPDATE medical_institution_info 
SET fixmedins_name = '北京市第一人民医院（总院）',
    exp_content = '{"地址":"北京市朝阳区某某街道123号","电话":"010-12345678","床位数":800}',
    sync_time = CURRENT_TIMESTAMP
WHERE fixmedins_code = 'H12345678901';

-- 更新同步状态
UPDATE medical_institution_sync_control 
SET sync_status = 'completed',
    last_sync_time = CURRENT_TIMESTAMP,
    next_sync_time = CURRENT_TIMESTAMP + INTERVAL '6 hours',
    sync_record_count = 2500;
```

### 4.4 模拟接口调用查询

```sql
-- 模拟1201接口的查询逻辑
-- 输入：fixmedins_type='1', fixmedins_name='人民医院'
SELECT 
    fixmedins_code,
    fixmedins_name,
    uscc,
    fixmedins_type,
    hosp_lv,
    exp_content
FROM medical_institution_info 
WHERE fixmedins_type = '1' 
AND fixmedins_name LIKE '%人民医院%'
ORDER BY fixmedins_name;

-- 输入：fixmedins_code='H12345678901'
SELECT 
    fixmedins_code,
    fixmedins_name,
    uscc,
    fixmedins_type,
    hosp_lv,
    exp_content
FROM medical_institution_info 
WHERE fixmedins_code = 'H12345678901';
```

## 5. 字段对应关系

| 接口字段 | 数据库字段 | 数据类型 | 长度 | 非空 | 说明 |
|---------|-----------|---------|------|------|------|
| fixmedins_code | fixmedins_code | VARCHAR | 12 | Y | 定点医药机构编号 |
| fixmedins_name | fixmedins_name | VARCHAR | 200 | Y | 定点医药机构名称 |
| uscc | uscc | VARCHAR | 50 | Y | 统一社会信用代码 |
| fixmedins_type | fixmedins_type | VARCHAR | 6 | Y | 定点医疗服务机构类型 |
| hosp_lv | hosp_lv | VARCHAR | 6 | N | 医院等级 |
| exp_content | exp_content | VARCHAR | 4000 | N | 扩展字段 |

## 6. 代码标识说明

根据接口文档，以下字段使用代码标识：

- **fixmedins_type**（定点医疗服务机构类型）：
  - 1：定点医疗机构
  - 2：定点零售药店
  - 其他类型...

- **hosp_lv**（医院等级）：
  - 1：一级医院
  - 2：二级医院
  - 3：三级医院
  - 其他等级...

## 7. 查询优化建议

### 7.1 索引使用
- **主键查询**：使用 `fixmedins_code` 进行精确查找
- **模糊查询**：使用 `fixmedins_name` 进行LIKE查询或全文检索
- **分类查询**：使用 `fixmedins_type` 和 `hosp_lv` 进行筛选

### 7.2 查询性能优化
```sql
-- 复合索引：支持按类型和等级查询
CREATE INDEX idx_medical_institution_type_level 
ON medical_institution_info(fixmedins_type, hosp_lv);

-- 复合索引：支持按类型和名称查询
CREATE INDEX idx_medical_institution_type_name 
ON medical_institution_info(fixmedins_type, fixmedins_name);
```

### 7.3 数据同步优化
```sql
-- 查询需要同步的数据
SELECT * FROM medical_institution_info 
WHERE sync_time > (
    SELECT COALESCE(last_sync_time, '1970-01-01'::timestamp) 
    FROM medical_institution_sync_control 
    WHERE sync_type = 'incremental'
);
```

## 8. 表结构特点

1. **完全对应接口字段**：表字段与接口输出字段一一对应
2. **支持模糊查询**：为机构名称建立多种查询索引
3. **扩展性好**：exp_content字段支持JSON格式扩展信息
4. **同步机制**：支持增量同步和全量同步
5. **查询优化**：针对常用查询场景建立合适索引

这个表结构设计完全符合1201接口的要求，支持高效的数据存储、查询和同步。