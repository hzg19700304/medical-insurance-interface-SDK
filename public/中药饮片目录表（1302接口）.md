# 1302接口对应的中药饮片目录表

## 1. 中药饮片目录表 (herbal_medicine_catalog)

```sql
-- 中药饮片目录表（1302接口对应，包含33个字段）
CREATE TABLE herbal_medicine_catalog (
    id BIGSERIAL PRIMARY KEY,
    
    -- 第1-10列：基本信息
    med_list_codg VARCHAR(50) NOT NULL,                 -- 第1列：医疗目录编码
    herb_name VARCHAR(200),                             -- 第2列：单味药名称
    single_comp_flag VARCHAR(10),                       -- 第3列：单复方标志
    qual_lv VARCHAR(20),                                -- 第4列：质量等级
    herb_year VARCHAR(20),                              -- 第5列：中草药年份
    med_part VARCHAR(100),                              -- 第6列：药用部位
    safe_dosage VARCHAR(100),                           -- 第7列：安全计量
    usual_usage VARCHAR(200),                           -- 第8列：常规用法
    nature_flavor VARCHAR(100),                         -- 第9列：性味
    meridian VARCHAR(100),                              -- 第10列：归经
    
    -- 第11-20列：详细信息
    variety VARCHAR(100),                               -- 第11列：品种
    begndate DATE,                                      -- 第12列：开始日期
    enddate DATE,                                       -- 第13列：结束日期
    vali_flag VARCHAR(10),                              -- 第14列：有效标志
    uniq_record_no VARCHAR(100),                        -- 第15列：唯一记录号
    data_crte_time TIMESTAMP,                           -- 第16列：数据创建时间
    data_updt_time TIMESTAMP,                           -- 第17列：数据更新时间
    ver VARCHAR(50),                                    -- 第18列：版本号
    ver_name VARCHAR(100),                              -- 第19列：版本名称
    herb_material_name VARCHAR(200),                    -- 第20列：药材名称
    
    -- 第21-30列：功能和政策信息
    func_indic TEXT,                                    -- 第21列：功能主治
    process_method VARCHAR(200),                        -- 第22列：炮制方法
    efficacy_class VARCHAR(100),                        -- 第23列：功效分类
    material_source VARCHAR(200),                       -- 第24列：药材种来源
    natl_hilist_policy TEXT,                            -- 第25列：国家医保支付政策
    prov_hilist_policy TEXT,                            -- 第26列：省级医保支付政策
    std_name VARCHAR(200),                              -- 第27列：标准名称
    std_page_no VARCHAR(50),                            -- 第28列：标准页码
    std_file TEXT,                                      -- 第29列：标准电子档案
    down_flag VARCHAR(10),                              -- 第30列：下发标志
    
    -- 第31-33列：传输和时间信息
    trans_data_id VARCHAR(100),                         -- 第31列：传输数据ID
    efft_time TIMESTAMP,                                -- 第32列：生效时间
    expr_time TIMESTAMP,                                -- 第33列：失效时间
    
    -- 同步相关字段
    sync_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,      -- 同步时间
    data_version VARCHAR(50),                           -- 数据版本号
    
    -- 审计字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建主要索引
CREATE UNIQUE INDEX idx_herbal_medicine_catalog_med_list_codg ON herbal_medicine_catalog(med_list_codg);
CREATE INDEX idx_herbal_medicine_catalog_herb_name ON herbal_medicine_catalog(herb_name);
CREATE INDEX idx_herbal_medicine_catalog_herb_material_name ON herbal_medicine_catalog(herb_material_name);
CREATE INDEX idx_herbal_medicine_catalog_single_comp_flag ON herbal_medicine_catalog(single_comp_flag);
CREATE INDEX idx_herbal_medicine_catalog_qual_lv ON herbal_medicine_catalog(qual_lv);
CREATE INDEX idx_herbal_medicine_catalog_vali_flag ON herbal_medicine_catalog(vali_flag);
CREATE INDEX idx_herbal_medicine_catalog_variety ON herbal_medicine_catalog(variety);
CREATE INDEX idx_herbal_medicine_catalog_efficacy_class ON herbal_medicine_catalog(efficacy_class);
CREATE INDEX idx_herbal_medicine_catalog_begndate ON herbal_medicine_catalog(begndate);
CREATE INDEX idx_herbal_medicine_catalog_enddate ON herbal_medicine_catalog(enddate);
CREATE INDEX idx_herbal_medicine_catalog_sync_time ON herbal_medicine_catalog(sync_time);
CREATE INDEX idx_herbal_medicine_catalog_data_version ON herbal_medicine_catalog(data_version);
CREATE INDEX idx_herbal_medicine_catalog_uniq_record_no ON herbal_medicine_catalog(uniq_record_no);
CREATE INDEX idx_herbal_medicine_catalog_down_flag ON herbal_medicine_catalog(down_flag);
CREATE INDEX idx_herbal_medicine_catalog_efft_time ON herbal_medicine_catalog(efft_time);
CREATE INDEX idx_herbal_medicine_catalog_expr_time ON herbal_medicine_catalog(expr_time);

-- 创建搜索索引
CREATE INDEX idx_herbal_medicine_catalog_herb_name_search ON herbal_medicine_catalog USING gin(to_tsvector('simple', herb_name));
CREATE INDEX idx_herbal_medicine_catalog_material_name_search ON herbal_medicine_catalog USING gin(to_tsvector('simple', herb_material_name));
CREATE INDEX idx_herbal_medicine_catalog_func_indic_search ON herbal_medicine_catalog USING gin(to_tsvector('simple', func_indic));

-- 创建复合索引
CREATE INDEX idx_herbal_medicine_catalog_flag_date ON herbal_medicine_catalog(vali_flag, begndate, enddate);
CREATE INDEX idx_herbal_medicine_catalog_comp_variety ON herbal_medicine_catalog(single_comp_flag, variety);
CREATE INDEX idx_herbal_medicine_catalog_qual_part ON herbal_medicine_catalog(qual_lv, med_part);
```

## 2. 文件下载记录表

```sql
-- 中药饮片文件下载记录表（记录1302接口的文件下载信息）
CREATE TABLE herbal_medicine_download_log (
    id BIGSERIAL PRIMARY KEY,
    
    -- 接口返回的4个字段
    file_qury_no VARCHAR(40) NOT NULL,                  -- 文件查询号
    filename VARCHAR(100) NOT NULL,                     -- 文件名
    dld_end_time DATE NOT NULL,                         -- 下载截止日期
    data_cnt INTEGER,                                   -- 数据量
    
    -- 下载状态
    download_status VARCHAR(20) DEFAULT 'pending',      -- pending/downloading/completed/failed
    download_start_time TIMESTAMP,                      -- 开始下载时间
    download_end_time TIMESTAMP,                        -- 完成下载时间
    processed_count INTEGER DEFAULT 0,                  -- 已处理记录数
    error_message TEXT,                                 -- 错误信息
    
    -- 版本信息
    request_version VARCHAR(20),                        -- 请求版本号
    response_version VARCHAR(20),                       -- 响应版本号
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_herbal_medicine_download_log_file_qury_no ON herbal_medicine_download_log(file_qury_no);
CREATE INDEX idx_herbal_medicine_download_log_filename ON herbal_medicine_download_log(filename);
CREATE INDEX idx_herbal_medicine_download_log_dld_end_time ON herbal_medicine_download_log(dld_end_time);
CREATE INDEX idx_herbal_medicine_download_log_download_status ON herbal_medicine_download_log(download_status);
CREATE INDEX idx_herbal_medicine_download_log_request_version ON herbal_medicine_download_log(request_version);
```

## 3. 数据同步控制表

```sql
-- 中药饮片目录同步控制表
CREATE TABLE herbal_medicine_sync_control (
    id SERIAL PRIMARY KEY,
    sync_type VARCHAR(20) NOT NULL DEFAULT 'incremental', -- full/incremental
    local_version VARCHAR(20),                           -- 本地版本号
    remote_version VARCHAR(20),                          -- 远程版本号
    last_sync_time TIMESTAMP,                            -- 最后同步时间
    next_sync_time TIMESTAMP,                            -- 下次同步时间
    sync_status VARCHAR(20) DEFAULT 'pending',           -- pending/running/completed/failed
    sync_record_count INTEGER DEFAULT 0,                 -- 同步记录数
    file_qury_no VARCHAR(40),                            -- 当前文件查询号
    error_message TEXT,                                  -- 错误信息
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. 创建更新触发器

```sql
-- 创建更新时间触发器
CREATE TRIGGER update_herbal_medicine_catalog_updated_at 
    BEFORE UPDATE ON herbal_medicine_catalog 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_herbal_medicine_download_log_updated_at 
    BEFORE UPDATE ON herbal_medicine_download_log 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_herbal_medicine_sync_control_updated_at 
    BEFORE UPDATE ON herbal_medicine_sync_control 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## 5. 使用示例

### 5.1 数据插入示例

```sql
-- 插入中药饮片目录数据
INSERT INTO herbal_medicine_catalog (
    med_list_codg, herb_name, single_comp_flag, qual_lv, herb_year,
    med_part, safe_dosage, usual_usage, nature_flavor, meridian,
    variety, begndate, enddate, vali_flag, herb_material_name,
    func_indic, process_method, efficacy_class, material_source,
    std_name, ver, down_flag
) VALUES (
    'TCM001001', '甘草', '1', '一等', '2024年',
    '根茎', '3-9g', '煎服', '甘、平', '心、肺、脾、胃',
    '甘草', '2024-01-01', '2025-12-31', '1', '甘草',
    '补脾益气，清热解毒，祛痰止咳，缓急止痛，调和诸药', '蜜炙', '补益药', '野生',
    '甘草', 'V2024.1', '1'
);

-- 插入下载记录
INSERT INTO herbal_medicine_download_log (
    file_qury_no, filename, dld_end_time, data_cnt, 
    download_status, request_version
) VALUES (
    'HERB20250101001', 'herbal_medicine_20250101.csv', '2025-01-31', 5000,
    'completed', 'V2024.1'
);
```

### 5.2 数据查询示例

```sql
-- 按中药名称查询
SELECT med_list_codg, herb_name, herb_material_name, qual_lv, 
       med_part, func_indic, vali_flag
FROM herbal_medicine_catalog 
WHERE herb_name LIKE '%甘草%' 
AND vali_flag = '1';

-- 按药用部位查询
SELECT med_list_codg, herb_name, herb_material_name, med_part, safe_dosage
FROM herbal_medicine_catalog 
WHERE med_part LIKE '%根茎%' 
AND vali_flag = '1'
ORDER BY herb_name;

-- 按功效分类查询
SELECT med_list_codg, herb_name, herb_material_name, efficacy_class, func_indic
FROM herbal_medicine_catalog 
WHERE efficacy_class = '补益药' 
AND vali_flag = '1'
ORDER BY herb_name;

-- 按质量等级统计
SELECT qual_lv, COUNT(*) as herb_count
FROM herbal_medicine_catalog 
WHERE vali_flag = '1'
GROUP BY qual_lv
ORDER BY herb_count DESC;

-- 按单复方标志统计
SELECT 
    single_comp_flag,
    CASE single_comp_flag 
        WHEN '1' THEN '单方'
        WHEN '2' THEN '复方'
        ELSE '其他'
    END as comp_type_name,
    COUNT(*) as count
FROM herbal_medicine_catalog 
WHERE vali_flag = '1'
GROUP BY single_comp_flag
ORDER BY count DESC;

-- 查询特定年份的中药
SELECT med_list_codg, herb_name, herb_material_name, herb_year, qual_lv
FROM herbal_medicine_catalog 
WHERE herb_year = '2024年' 
AND vali_flag = '1'
ORDER BY herb_name;

-- 查询特定药材来源
SELECT med_list_codg, herb_name, herb_material_name, material_source, qual_lv
FROM herbal_medicine_catalog 
WHERE material_source = '野生' 
AND vali_flag = '1'
ORDER BY herb_name;

-- 查询即将失效的中药
SELECT med_list_codg, herb_name, herb_material_name, enddate
FROM herbal_medicine_catalog 
WHERE enddate BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '30 days'
AND vali_flag = '1'
ORDER BY enddate;

-- 按性味归经查询
SELECT med_list_codg, herb_name, herb_material_name, nature_flavor, meridian
FROM herbal_medicine_catalog 
WHERE nature_flavor LIKE '%甘%' 
AND meridian LIKE '%脾%'
AND vali_flag = '1'
ORDER BY herb_name;
```

### 5.3 数据更新示例

```sql
-- 更新中药信息
UPDATE herbal_medicine_catalog 
SET herb_name = '甘草（蜜炙）',
    process_method = '蜜炙法',
    qual_lv = '特等',
    data_updt_time = CURRENT_TIMESTAMP,
    sync_time = CURRENT_TIMESTAMP
WHERE med_list_codg = 'TCM001001';

-- 批量更新有效标志
UPDATE herbal_medicine_catalog 
SET vali_flag = '0',
    expr_time = CURRENT_TIMESTAMP
WHERE enddate < CURRENT_DATE;

-- 更新同步状态
UPDATE herbal_medicine_sync_control 
SET sync_status = 'completed',
    last_sync_time = CURRENT_TIMESTAMP,
    next_sync_time = CURRENT_TIMESTAMP + INTERVAL '24 hours',
    sync_record_count = 5000,
    remote_version = 'V2024.2';
```

### 5.4 版本控制查询

```sql
-- 获取本地最大版本号（用于1302接口请求）
SELECT COALESCE(MAX(local_version), '0') as max_version
FROM herbal_medicine_sync_control;

-- 查询版本变化情况
SELECT ver, ver_name, COUNT(*) as record_count
FROM herbal_medicine_catalog 
WHERE vali_flag = '1'
GROUP BY ver, ver_name
ORDER BY ver DESC;

-- 查询需要同步的数据
SELECT COUNT(*) as need_sync_count
FROM herbal_medicine_catalog 
WHERE sync_time < (
    SELECT COALESCE(last_sync_time, '1970-01-01'::timestamp) 
    FROM herbal_medicine_sync_control 
    WHERE sync_type = 'incremental'
);
```

### 5.5 医保政策查询

```sql
-- 查询国家医保支付政策
SELECT med_list_codg, herb_name, herb_material_name, natl_hilist_policy
FROM herbal_medicine_catalog 
WHERE natl_hilist_policy IS NOT NULL 
AND natl_hilist_policy != ''
AND vali_flag = '1'
ORDER BY herb_name;

-- 查询省级医保支付政策
SELECT med_list_codg, herb_name, herb_material_name, prov_hilist_policy
FROM herbal_medicine_catalog 
WHERE prov_hilist_policy IS NOT NULL 
AND prov_hilist_policy != ''
AND vali_flag = '1'
ORDER BY herb_name;

-- 对比国家和省级政策
SELECT 
    med_list_codg, 
    herb_name, 
    herb_material_name,
    CASE 
        WHEN natl_hilist_policy IS NOT NULL AND natl_hilist_policy != '' THEN '有国家政策'
        ELSE '无国家政策'
    END as natl_policy_status,
    CASE 
        WHEN prov_hilist_policy IS NOT NULL AND prov_hilist_policy != '' THEN '有省级政策'
        ELSE '无省级政策'
    END as prov_policy_status
FROM herbal_medicine_catalog 
WHERE vali_flag = '1'
ORDER BY herb_name;
```

## 6. 字段说明

### 6.1 核心字段
- **med_list_codg**：医疗目录编码，主要标识字段
- **herb_name**：单味药名称，常用查询字段
- **herb_material_name**：药材名称，标准名称
- **single_comp_flag**：单复方标志（1-单方，2-复方）
- **vali_flag**：有效标志，过滤无效数据

### 6.2 中药特色字段
- **qual_lv**：质量等级（特等、一等、二等等）
- **herb_year**：中草药年份
- **med_part**：药用部位（根茎、叶、花等）
- **nature_flavor**：性味（甘、苦、辛、酸、咸；寒、热、温、凉、平）
- **meridian**：归经（心、肝、脾、肺、肾等）

### 6.3 功能字段
- **func_indic**：功能主治
- **process_method**：炮制方法
- **efficacy_class**：功效分类
- **material_source**：药材种来源

### 6.4 政策字段
- **natl_hilist_policy**：国家医保支付政策
- **prov_hilist_policy**：省级医保支付政策

## 7. 数据同步流程

### 7.1 同步准备
1. 获取本地最大版本号
2. 调用1302接口获取文件信息
3. 记录文件下载信息

### 7.2 数据处理
1. 下载CSV文件
2. 解析33个字段数据
3. 批量插入或更新数据库
4. 更新同步状态

### 7.3 数据维护
1. 清理过期数据
2. 更新版本信息
3. 重建索引优化查询

## 8. 表结构特点

1. **完全对应接口字段**：表字段与接口输出字段一一对应（33个字段）
2. **中药特色支持**：专门的中药相关字段（性味、归经、炮制等）
3. **政策信息管理**：国家和省级医保支付政策字段
4. **版本控制机制**：支持增量同步和全量同步
5. **查询优化**：针对中药特色查询建立合适索引

这个表结构完全满足了1302接口的要求，保留了全部33个字段，并针对中药饮片的特点进行了优化设计。