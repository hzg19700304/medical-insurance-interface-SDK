# 1303接口对应的医疗机构制剂目录表

## 1. 医疗机构制剂目录表 (hospital_preparation_catalog)

```sql
-- 医疗机构制剂目录表（1303接口对应，包含83个字段）
CREATE TABLE hospital_preparation_catalog (
    id BIGSERIAL PRIMARY KEY,
    
    -- 第1-10列：基本信息
    med_list_codg VARCHAR(50) NOT NULL,                 -- 第1列：医疗目录编码
    drug_prodname VARCHAR(500),                         -- 第2列：药品商品名
    alias_name VARCHAR(500),                            -- 第3列：别名
    eng_name VARCHAR(500),                              -- 第4列：英文名称
    dosform VARCHAR(20),                                -- 第5列：剂型
    dosform_name VARCHAR(100),                          -- 第6列：剂型名称
    reg_dosform VARCHAR(20),                            -- 第7列：注册剂型
    comp VARCHAR(1000),                                 -- 第8列：成分
    func_indic TEXT,                                    -- 第9列：功能主治
    charact VARCHAR(500),                               -- 第10列：性状
    
    -- 第11-20列：规格和用法信息
    drug_spec VARCHAR(200),                             -- 第11列：药品规格
    drug_spec_code VARCHAR(50),                         -- 第12列：药品规格代码
    reg_spec VARCHAR(200),                              -- 第13列：注册规格
    reg_spec_code VARCHAR(50),                          -- 第14列：注册规格代码
    drug_route VARCHAR(100),                            -- 第15列：给药途径
    storage VARCHAR(200),                               -- 第16列：贮藏
    used_frqu VARCHAR(100),                             -- 第17列：使用频次
    each_dos VARCHAR(100),                              -- 第18列：每次用量
    drug_type VARCHAR(20),                              -- 第19列：药品类别
    drug_type_name VARCHAR(100),                        -- 第20列：药品类别名称
    
    -- 第21-30列：包装信息
    otc_flag VARCHAR(10),                               -- 第21列：非处方药标志
    otc_flag_name VARCHAR(100),                         -- 第22列：非处方药标志名称
    pacmatl VARCHAR(20),                                -- 第23列：包装材质
    pacmatl_name VARCHAR(100),                          -- 第24列：包装材质名称
    pacspec VARCHAR(200),                               -- 第25列：包装规格
    drug_instruc TEXT,                                  -- 第26列：说明书
    pac_quan DECIMAL(10,2),                             -- 第27列：包装数量
    min_use_unit VARCHAR(50),                           -- 第28列：最小使用单位
    min_sale_unit VARCHAR(50),                          -- 第29列：最小销售单位
    min_dosage_unit VARCHAR(50),                        -- 第30列：最小计量单位
    
    -- 第31-40列：计量单位和企业信息
    min_pac_quan DECIMAL(10,2),                         -- 第31列：最小包装数量
    min_pac_unit VARCHAR(50),                           -- 第32列：最小包装单位
    min_prep_unit VARCHAR(50),                          -- 第33列：最小制剂单位
    min_prep_unit_name VARCHAR(100),                    -- 第34列：最小制剂单位名称
    drug_expy VARCHAR(50),                              -- 第35列：药品有效期
    min_pric_unit VARCHAR(50),                          -- 第36列：最小计价单位
    adv_reac TEXT,                                      -- 第37列：不良反应
    precautions TEXT,                                   -- 第38列：注意事项
    contraindicatio TEXT,                               -- 第39列：禁忌
    prod_entps_code VARCHAR(50),                        -- 第40列：生产企业编号
    
    -- 第41-50列：企业和注册信息
    prod_entps_name VARCHAR(200),                       -- 第41列：生产企业名称
    prod_entps_addr VARCHAR(500),                       -- 第42列：生产企业地址
    spcl_lmtpric_drug_flag VARCHAR(10),                 -- 第43列：特殊限价药品标志
    aprvl_no VARCHAR(100),                              -- 第44列：批准文号
    aprvl_no_begndate DATE,                             -- 第45列：批准文号开始日期
    aprvl_no_enddate DATE,                              -- 第46列：批准文号结束日期
    drug_reg_cert_no VARCHAR(100),                      -- 第47列：药品注册证号
    drug_reg_cert_begndate DATE,                        -- 第48列：药品注册证号开始日期
    drug_reg_cert_enddate DATE,                         -- 第49列：药品注册证号结束日期
    conv_ratio DECIMAL(10,4),                           -- 第50列：转换比
    
    -- 第51-60列：限制使用和医保信息
    lmt_use_range VARCHAR(500),                         -- 第51列：限制使用范围
    min_pac_unit_name VARCHAR(100),                     -- 第52列：最小包装单位名称
    reg_name VARCHAR(500),                              -- 第53列：注册名称
    subpac_manuf VARCHAR(200),                          -- 第54列：分包装厂家
    markt_stas VARCHAR(10),                             -- 第55列：市场状态
    drug_reg_file TEXT,                                 -- 第56列：药品注册批件电子档案
    drug_suppl_file TEXT,                               -- 第57列：药品补充申请批件电子档案
    hilist_code VARCHAR(50),                            -- 第58列：国家医保药品目录编号
    hilist_memo TEXT,                                   -- 第59列：国家医保药品目录备注
    vat_adj_drug_flag VARCHAR(10),                      -- 第60列：增值税调整药品标志
    
    -- 第61-70列：备注和版本信息
    vat_adj_drug_name VARCHAR(100),                     -- 第61列：增值税调整药品名称
    mkt_drug_list VARCHAR(10),                          -- 第62列：上市药品目录集药品
    nhc_drug_code VARCHAR(50),                          -- 第63列：卫健委药品编码
    memo TEXT,                                          -- 第64列：备注
    vali_flag VARCHAR(10),                              -- 第65列：有效标志
    begntime TIMESTAMP,                                 -- 第66列：开始时间
    endtime TIMESTAMP,                                  -- 第67列：结束时间
    uniq_record_no VARCHAR(100),                        -- 第68列：唯一记录号
    data_crte_time TIMESTAMP,                           -- 第69列：数据创建时间
    data_updt_time TIMESTAMP,                           -- 第70列：数据更新时间
    
    -- 第71-83列：制剂特有信息
    ver VARCHAR(50),                                    -- 第71列：版本号
    ver_name VARCHAR(100),                              -- 第72列：版本名称
    prep_cert_no VARCHAR(100),                          -- 第73列：自制剂许可证号
    chld_drug VARCHAR(10),                              -- 第74列：儿童用药
    elderly_drug VARCHAR(10),                           -- 第75列：老年患者用药
    medins_cont_name VARCHAR(100),                      -- 第76列：医疗机构联系人姓名
    medins_cont_tel VARCHAR(20),                        -- 第77列：医疗机构联系人电话
    prep_cert_file TEXT,                                -- 第78列：自制剂许可证电子档案
    down_flag VARCHAR(10),                              -- 第79列：下发标志
    trans_data_id VARCHAR(100),                         -- 第80列：传输数据ID
    loc_area VARCHAR(50),                               -- 第81列：所在地区
    hosp_prep_applnt_name VARCHAR(200),                 -- 第82列：医院制剂申请人单位名称
    hosp_prep_applnt_addr VARCHAR(500),                 -- 第83列：医院制剂申请人单位地址
    
    -- 同步相关字段
    sync_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,      -- 同步时间
    data_version VARCHAR(50),                           -- 数据版本号
    
    -- 审计字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建主要索引
CREATE UNIQUE INDEX idx_hospital_preparation_catalog_med_list_codg ON hospital_preparation_catalog(med_list_codg);
CREATE INDEX idx_hospital_preparation_catalog_drug_prodname ON hospital_preparation_catalog(drug_prodname);
CREATE INDEX idx_hospital_preparation_catalog_alias_name ON hospital_preparation_catalog(alias_name);
CREATE INDEX idx_hospital_preparation_catalog_dosform ON hospital_preparation_catalog(dosform);
CREATE INDEX idx_hospital_preparation_catalog_drug_type ON hospital_preparation_catalog(drug_type);
CREATE INDEX idx_hospital_preparation_catalog_prod_entps_code ON hospital_preparation_catalog(prod_entps_code);
CREATE INDEX idx_hospital_preparation_catalog_prod_entps_name ON hospital_preparation_catalog(prod_entps_name);
CREATE INDEX idx_hospital_preparation_catalog_vali_flag ON hospital_preparation_catalog(vali_flag);
CREATE INDEX idx_hospital_preparation_catalog_prep_cert_no ON hospital_preparation_catalog(prep_cert_no);
CREATE INDEX idx_hospital_preparation_catalog_aprvl_no ON hospital_preparation_catalog(aprvl_no);
CREATE INDEX idx_hospital_preparation_catalog_drug_reg_cert_no ON hospital_preparation_catalog(drug_reg_cert_no);
CREATE INDEX idx_hospital_preparation_catalog_hilist_code ON hospital_preparation_catalog(hilist_code);
CREATE INDEX idx_hospital_preparation_catalog_begntime ON hospital_preparation_catalog(begntime);
CREATE INDEX idx_hospital_preparation_catalog_endtime ON hospital_preparation_catalog(endtime);
CREATE INDEX idx_hospital_preparation_catalog_sync_time ON hospital_preparation_catalog(sync_time);
CREATE INDEX idx_hospital_preparation_catalog_data_version ON hospital_preparation_catalog(data_version);
CREATE INDEX idx_hospital_preparation_catalog_uniq_record_no ON hospital_preparation_catalog(uniq_record_no);
CREATE INDEX idx_hospital_preparation_catalog_down_flag ON hospital_preparation_catalog(down_flag);
CREATE INDEX idx_hospital_preparation_catalog_loc_area ON hospital_preparation_catalog(loc_area);
CREATE INDEX idx_hospital_preparation_catalog_hosp_prep_applnt_name ON hospital_preparation_catalog(hosp_prep_applnt_name);

-- 创建搜索索引
CREATE INDEX idx_hospital_preparation_catalog_prodname_search ON hospital_preparation_catalog USING gin(to_tsvector('simple', drug_prodname));
CREATE INDEX idx_hospital_preparation_catalog_alias_search ON hospital_preparation_catalog USING gin(to_tsvector('simple', alias_name));
CREATE INDEX idx_hospital_preparation_catalog_func_indic_search ON hospital_preparation_catalog USING gin(to_tsvector('simple', func_indic));

-- 创建复合索引
CREATE INDEX idx_hospital_preparation_catalog_type_flag ON hospital_preparation_catalog(drug_type, vali_flag);
CREATE INDEX idx_hospital_preparation_catalog_dosform_spec ON hospital_preparation_catalog(dosform, drug_spec);
CREATE INDEX idx_hospital_preparation_catalog_entps_area ON hospital_preparation_catalog(prod_entps_code, loc_area);
CREATE INDEX idx_hospital_preparation_catalog_cert_date ON hospital_preparation_catalog(prep_cert_no, begntime, endtime);
```

## 2. 文件下载记录表

```sql
-- 医疗机构制剂文件下载记录表（记录1303接口的文件下载信息）
CREATE TABLE hospital_preparation_download_log (
    id BIGSERIAL PRIMARY KEY,
    
    -- 接口返回的4个字段
    file_qury_no VARCHAR(40) NOT NULL,                  -- 文件查询号
    filename VARCHAR(100) NOT NULL,                     -- 文件名
    dld_end_time DATE NOT NULL,                         -- 下载截止日期
    data_cnt INTEGER,                                   -- 数据量
    
    -- 下载状态
    download_status VARCHAR(20) DEFAULT 'pending',      -- pending/downloading/completed/failed
    download_start_time TIMESTAMP,                      -- 开始下载时间
    download_end_time TIMESTAMP,                        -- 完成下载时间
    processed_count INTEGER DEFAULT 0,                  -- 已处理记录数
    error_message TEXT,                                 -- 错误信息
    
    -- 版本信息
    request_version VARCHAR(20),                        -- 请求版本号
    response_version VARCHAR(20),                       -- 响应版本号
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_hospital_preparation_download_log_file_qury_no ON hospital_preparation_download_log(file_qury_no);
CREATE INDEX idx_hospital_preparation_download_log_filename ON hospital_preparation_download_log(filename);
CREATE INDEX idx_hospital_preparation_download_log_dld_end_time ON hospital_preparation_download_log(dld_end_time);
CREATE INDEX idx_hospital_preparation_download_log_download_status ON hospital_preparation_download_log(download_status);
CREATE INDEX idx_hospital_preparation_download_log_request_version ON hospital_preparation_download_log(request_version);
```

## 3. 数据同步控制表

```sql
-- 医疗机构制剂目录同步控制表
CREATE TABLE hospital_preparation_sync_control (
    id SERIAL PRIMARY KEY,
    sync_type VARCHAR(20) NOT NULL DEFAULT 'incremental', -- full/incremental
    local_version VARCHAR(20),                           -- 本地版本号
    remote_version VARCHAR(20),                          -- 远程版本号
    last_sync_time TIMESTAMP,                            -- 最后同步时间
    next_sync_time TIMESTAMP,                            -- 下次同步时间
    sync_status VARCHAR(20) DEFAULT 'pending',           -- pending/running/completed/failed
    sync_record_count INTEGER DEFAULT 0,                 -- 同步记录数
    file_qury_no VARCHAR(40),                            -- 当前文件查询号
    error_message TEXT,                                  -- 错误信息
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. 创建更新触发器

```sql
-- 创建更新时间触发器
CREATE TRIGGER update_hospital_preparation_catalog_updated_at 
    BEFORE UPDATE ON hospital_preparation_catalog 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_hospital_preparation_download_log_updated_at 
    BEFORE UPDATE ON hospital_preparation_download_log 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_hospital_preparation_sync_control_updated_at 
    BEFORE UPDATE ON hospital_preparation_sync_control 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## 5. 使用示例

### 5.1 数据插入示例

```sql
-- 插入医疗机构制剂目录数据
INSERT INTO hospital_preparation_catalog (
    med_list_codg, drug_prodname, alias_name, eng_name, dosform, dosform_name,
    comp, func_indic, charact, drug_spec, drug_route, storage,
    used_frqu, each_dos, drug_type, drug_type_name, prod_entps_code,
    prod_entps_name, prod_entps_addr, prep_cert_no, aprvl_no,
    vali_flag, begntime, endtime, ver, loc_area, hosp_prep_applnt_name,
    medins_cont_name, medins_cont_tel
) VALUES (
    'HOSP001001', '某某医院复方止咳糖浆', '止咳糖浆', 'Compound Cough Syrup', 
    '12', '糖浆剂', '桔梗流浸膏、甘草流浸膏等', '止咳化痰', '棕红色澄清液体',
    '100ml/瓶', '口服', '密封，在阴凉干燥处保存', '每日3次', '每次10ml',
    '1', '化学药品', 'ENT_HOSP001', '某某医院制剂室', '某某市某某区某某路123号',
    'ZZ20240001', 'Z20240001', '1', '2024-01-01 00:00:00', '2025-12-31 23:59:59',
    'V2024.1', '110100', '某某医院', '张三', '010-12345678'
);

-- 插入下载记录
INSERT INTO hospital_preparation_download_log (
    file_qury_no, filename, dld_end_time, data_cnt, 
    download_status, request_version
) VALUES (
    'HOSP20250101001', 'hospital_preparation_20250101.csv', '2025-01-31', 1000,
    'completed', 'V2024.1'
);
```

### 5.2 数据查询示例

```sql
-- 按药品名称查询
SELECT med_list_codg, drug_prodname, alias_name, dosform_name, 
       drug_spec, prod_entps_name, vali_flag
FROM hospital_preparation_catalog 
WHERE drug_prodname LIKE '%止咳%' 
AND vali_flag = '1';

-- 按生产企业查询
SELECT med_list_codg, drug_prodname, alias_name, drug_spec, 
       prod_entps_name, hosp_prep_applnt_name
FROM hospital_preparation_catalog 
WHERE prod_entps_name LIKE '%医院%' 
AND vali_flag = '1'
ORDER BY drug_prodname;

-- 按自制剂许可证号查询
SELECT med_list_codg, drug_prodname, alias_name, prep_cert_no,
       prod_entps_name, hosp_prep_applnt_name
FROM hospital_preparation_catalog 
WHERE prep_cert_no = 'ZZ20240001' 
AND vali_flag = '1';

-- 按所在地区查询
SELECT med_list_codg, drug_prodname, alias_name, loc_area,
       hosp_prep_applnt_name, medins_cont_name, medins_cont_tel
FROM hospital_preparation_catalog 
WHERE loc_area = '110100' 
AND vali_flag = '1'
ORDER BY drug_prodname;

-- 按药品类别统计
SELECT drug_type, drug_type_name, COUNT(*) as prep_count
FROM hospital_preparation_catalog 
WHERE vali_flag = '1'
GROUP BY drug_type, drug_type_name
ORDER BY prep_count DESC;

-- 查询儿童用药
SELECT med_list_codg, drug_prodname, alias_name, chld_drug,
       func_indic, each_dos, used_frqu
FROM hospital_preparation_catalog 
WHERE chld_drug = '1' 
AND vali_flag = '1'
ORDER BY drug_prodname;

-- 查询老年患者用药
SELECT med_list_codg, drug_prodname, alias_name, elderly_drug,
       func_indic, precautions, contraindicatio
FROM hospital_preparation_catalog 
WHERE elderly_drug = '1' 
AND vali_flag = '1'
ORDER BY drug_prodname;

-- 查询即将到期的制剂
SELECT med_list_codg, drug_prodname, alias_name, endtime,
       prod_entps_name, prep_cert_no
FROM hospital_preparation_catalog 
WHERE endtime BETWEEN CURRENT_TIMESTAMP AND CURRENT_TIMESTAMP + INTERVAL '30 days'
AND vali_flag = '1'
ORDER BY endtime;

-- 查询特定剂型的制剂
SELECT med_list_codg, drug_prodname, alias_name, dosform, dosform_name,
       drug_spec, func_indic
FROM hospital_preparation_catalog 
WHERE dosform = '12' -- 糖浆剂
AND vali_flag = '1'
ORDER BY drug_prodname;
```

### 5.3 数据更新示例

```sql
-- 更新制剂信息
UPDATE hospital_preparation_catalog 
SET drug_prodname = '某某医院复方止咳糖浆（改良版）',
    drug_spec = '120ml/瓶',
    each_dos = '每次15ml',
    data_updt_time = CURRENT_TIMESTAMP,
    sync_time = CURRENT_TIMESTAMP
WHERE med_list_codg = 'HOSP001001';

-- 更新联系人信息
UPDATE hospital_preparation_catalog 
SET medins_cont_name = '李四',
    medins_cont_tel = '010-87654321',
    data_updt_time = CURRENT_TIMESTAMP
WHERE hosp_prep_applnt_name = '某某医院';

-- 批量更新有效标志
UPDATE hospital_preparation_catalog 
SET vali_flag = '0',
    endtime = CURRENT_TIMESTAMP
WHERE endtime < CURRENT_TIMESTAMP;

-- 更新同步状态
UPDATE hospital_preparation_sync_control 
SET sync_status = 'completed',
    last_sync_time = CURRENT_TIMESTAMP,
    next_sync_time = CURRENT_TIMESTAMP + INTERVAL '24 hours',
    sync_record_count = 1000,
    remote_version = 'V2024.2';
```

### 5.4 版本控制查询

```sql
-- 获取本地最大版本号（用于1303接口请求）
SELECT COALESCE(MAX(local_version), '0') as max_version
FROM hospital_preparation_sync_control;

-- 查询版本变化情况
SELECT ver, ver_name, COUNT(*) as record_count
FROM hospital_preparation_catalog 
WHERE vali_flag = '1'
GROUP BY ver, ver_name
ORDER BY ver DESC;

-- 查询需要同步的数据
SELECT COUNT(*) as need_sync_count
FROM hospital_preparation_catalog 
WHERE sync_time < (
    SELECT COALESCE(last_sync_time, '1970-01-01'::timestamp) 
    FROM hospital_preparation_sync_control 
    WHERE sync_type = 'incremental'
);
```

### 5.5 制剂许可证管理查询

```sql
-- 查询许可证信息
SELECT 
    prep_cert_no,
    COUNT(*) as prep_count,
    STRING_AGG(DISTINCT hosp_prep_applnt_name, ', ') as hospitals
FROM hospital_preparation_catalog 
WHERE vali_flag = '1'
AND prep_cert_no IS NOT NULL
GROUP BY prep_cert_no
ORDER BY prep_count DESC;

-- 查询没有许可证的制剂
SELECT med_list_codg, drug_prodname, alias_name, hosp_prep_applnt_name
FROM hospital_preparation_catalog 
WHERE prep_cert_no IS NULL 
AND vali_flag = '1'
ORDER BY drug_prodname;

-- 查询联系人信息
SELECT 
    hosp_prep_applnt_name,
    medins_cont_name,
    medins_cont_tel,
    COUNT(*) as prep_count
FROM hospital_preparation_catalog 
WHERE vali_flag = '1'
GROUP BY hosp_prep_applnt_name, medins_cont_name, medins_cont_tel
ORDER BY prep_count DESC;
```

### 5.6 安全性查询

```sql
-- 查询有禁忌的制剂
SELECT med_list_codg, drug_prodname, alias_name, contraindicatio,
       precautions, adv_reac
FROM hospital_preparation_catalog 
WHERE contraindicatio IS NOT NULL 
AND contraindicatio != ''
AND vali_flag = '1'
ORDER BY drug_prodname;

-- 查询需要特殊贮藏的制剂
SELECT med_list_codg, drug_prodname, alias_name, storage,
       drug_expy, hosp_prep_applnt_name
FROM hospital_preparation_catalog 
WHERE storage LIKE '%低温%' 
OR storage LIKE '%冷藏%'
OR storage LIKE '%避光%'
AND vali_flag = '1'
ORDER BY drug_prodname;
```

## 6. 字段说明

### 6.1 核心字段
- **med_list_codg**：医疗目录编码，主要标识字段
- **drug_prodname**：药品商品名，常用查询字段
- **alias_name**：别名，辅助查询字段
- **vali_flag**：有效标志，过滤无效数据
- **begntime/endtime**：有效期，时间范围查询

### 6.2 制剂特有字段
- **prep_cert_no**：自制剂许可证号，制剂特有
- **hosp_prep_applnt_name**：医院制剂申请人单位名称
- **medins_cont_name**：医疗机构联系人姓名
- **medins_cont_tel**：医疗机构联系人电话
- **loc_area**：所在地区

### 6.3 药品安全字段
- **adv_reac**：不良反应
- **precautions**：注意事项
- **contraindicatio**：禁忌
- **chld_drug**：儿童用药标志
- **elderly_drug**：老年患者用药标志

### 6.4 规格包装字段
- **drug_spec**：药品规格
- **dosform**：剂型
- **pacspec**：包装规格
- **storage**：贮藏条件
- **drug_expy**：药品有效期

## 7. 数据同步流程

### 7.1 同步准备
1. 获取本地最大版本号
2. 调用1303接口获取文件信息
3. 记录文件下载信息

### 7.2 数据处理
1. 下载CSV文件
2. 解析83个字段数据
3. 批量插入或更新数据库
4. 更新同步状态

### 7.3 数据维护
1. 清理过期数据
2. 更新版本信息
3. 重建索引优化查询

## 8. 表结构特点

1. **完全对应接口字段**：表字段与接口输出字段一一对应（83个字段）
2. **医疗机构制剂特色**：包含许可证、联系人等制剂特有信息
3. **安全性管理**：包含禁忌、注意事项、不良反应等安全信息
4. **版本控制机制**：支持增量同步和全量同步
5. **地区管理**：支持按地区查询和管理制剂信息

这个表结构完全满足了1303接口的要求，保留了全部83个字段，并针对医疗机构制剂的特点进行了优化设计，特别是加强了安全性和管理性字段的索引。