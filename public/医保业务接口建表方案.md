# 医保业务接口建表方案

## 1. 核心设计思路

### 1.1 建表原则
- **一张核心表**：记录所有174个接口的调用日志
- **少量专项表**：只为有明确业务状态和生命周期的业务建表
- **灵活存储**：使用JSON字段适应不同接口的数据结构

### 1.2 表数量控制
- **核心表**：1张（business_operation_logs）
- **专项表**：5-7张
- **总计**：6-8张表处理174个接口

## 2. 具体建表方案

### 2.1 核心表：通用业务操作日志表（1张）

```sql
-- 通用业务操作日志表（覆盖所有174个接口）
CREATE TABLE business_operation_logs (
    id BIGSERIAL PRIMARY KEY,
    operation_id VARCHAR(100) NOT NULL UNIQUE,
    api_code VARCHAR(50) NOT NULL,
    api_name VARCHAR(200) NOT NULL,
    
    -- 业务分类
    business_category VARCHAR(50) NOT NULL, -- 结算业务、备案业务、查询业务等
    business_type VARCHAR(50) NOT NULL,     -- outpatient/inpatient/pharmacy等
    
    -- 机构和人员信息
    institution_code VARCHAR(50) NOT NULL,
    psn_no VARCHAR(50),
    mdtrt_id VARCHAR(50),
    
    -- 请求和响应数据
    request_data JSONB NOT NULL,
    response_data JSONB,
    
    -- 操作状态
    status VARCHAR(20) DEFAULT 'success', -- success/failed/pending/processing
    error_code VARCHAR(50),
    error_message TEXT,
    
    -- 时间信息
    operation_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    complete_time TIMESTAMP,
    
    -- 操作员信息
    operator_id VARCHAR(50),
    operator_name VARCHAR(100),
    
    -- 系统信息
    trace_id VARCHAR(100),
    client_ip VARCHAR(45),
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) PARTITION BY RANGE (operation_time);
```

### 2.2 专项表：有业务状态流转的接口（5-7张）

#### 2.2.1 结算业务表（1张）
```sql
-- 结算业务表（覆盖结算相关的17个接口）
CREATE TABLE settlement_business (
    id BIGSERIAL PRIMARY KEY,
    operation_log_id BIGINT REFERENCES business_operation_logs(id),
    
    -- 结算基本信息
    settlement_id VARCHAR(100) NOT NULL UNIQUE,
    settlement_type VARCHAR(20) NOT NULL, -- pharmacy/outpatient/inpatient
    settlement_subtype VARCHAR(20),       -- presettlement/settlement/cancel
    
    -- 关键业务字段
    mdtrt_id VARCHAR(50) NOT NULL,
    psn_no VARCHAR(50) NOT NULL,
    setl_id VARCHAR(50),
    
    -- 金额信息
    medfee_sumamt DECIMAL(16,2),
    psn_part_amt DECIMAL(16,2),
    fund_pay_sumamt DECIMAL(16,2),
    
    -- 结算状态
    settlement_status VARCHAR(20) DEFAULT 'completed',
    
    -- 详细数据
    settlement_detail JSONB,
    
    -- 时间
    settlement_time TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.2 备案业务表（1张）
```sql
-- 备案业务表（覆盖备案相关的7个接口）
CREATE TABLE registration_business (
    id BIGSERIAL PRIMARY KEY,
    operation_log_id BIGINT REFERENCES business_operation_logs(id),
    
    -- 备案基本信息
    registration_id VARCHAR(100) NOT NULL UNIQUE,
    registration_type VARCHAR(50) NOT NULL, -- chronic_disease/transfer/appointment/accident
    registration_action VARCHAR(20) NOT NULL, -- register/cancel
    
    -- 关键业务字段
    psn_no VARCHAR(50) NOT NULL,
    trt_dcla_detl_sn VARCHAR(50),
    
    -- 备案状态
    registration_status VARCHAR(20) DEFAULT 'pending', -- pending/approved/rejected/cancelled
    
    -- 详细数据
    registration_detail JSONB NOT NULL,
    
    -- 审核信息
    audit_opinion TEXT,
    audit_time TIMESTAMP,
    
    -- 有效期
    effective_date DATE,
    expiry_date DATE,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.3 住院业务表（1张）
```sql
-- 住院业务表（覆盖住院相关的5个接口）
CREATE TABLE inpatient_business (
    id BIGSERIAL PRIMARY KEY,
    operation_log_id BIGINT REFERENCES business_operation_logs(id),
    
    -- 住院基本信息
    inpatient_id VARCHAR(100) NOT NULL UNIQUE,
    inpatient_action VARCHAR(20) NOT NULL, -- admission/discharge/modify/cancel
    
    -- 关键业务字段
    mdtrt_id VARCHAR(50) NOT NULL,
    psn_no VARCHAR(50) NOT NULL,
    
    -- 住院状态
    inpatient_status VARCHAR(20) DEFAULT 'active', -- active/discharged/cancelled
    
    -- 详细数据
    inpatient_detail JSONB NOT NULL,
    
    -- 时间
    admission_time TIMESTAMP,
    discharge_time TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.4 电子处方业务表（1张）
```sql
-- 电子处方业务表（覆盖电子处方相关的20个接口）
CREATE TABLE prescription_business (
    id BIGSERIAL PRIMARY KEY,
    operation_log_id BIGINT REFERENCES business_operation_logs(id),
    
    -- 处方基本信息
    prescription_id VARCHAR(100) NOT NULL UNIQUE,
    prescription_action VARCHAR(20) NOT NULL, -- upload/download/verify/dispense
    prescription_source VARCHAR(20) NOT NULL, -- hospital/pharmacy
    
    -- 关键业务字段
    psn_no VARCHAR(50) NOT NULL,
    fixmedins_code VARCHAR(50) NOT NULL,
    
    -- 处方状态
    prescription_status VARCHAR(20) DEFAULT 'uploaded', -- uploaded/verified/dispensed/cancelled
    
    -- 详细数据
    prescription_detail JSONB NOT NULL,
    
    -- 时间
    prescription_time TIMESTAMP,
    dispense_time TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.5 线上支付业务表（1张）
```sql
-- 线上支付业务表（覆盖线上支付相关的8个接口）
CREATE TABLE online_payment_business (
    id BIGSERIAL PRIMARY KEY,
    operation_log_id BIGINT REFERENCES business_operation_logs(id),
    
    -- 支付基本信息
    payment_id VARCHAR(100) NOT NULL UNIQUE,
    payment_action VARCHAR(20) NOT NULL, -- order/pay/refund/query
    
    -- 关键业务字段
    psn_no VARCHAR(50) NOT NULL,
    order_no VARCHAR(50),
    
    -- 支付状态
    payment_status VARCHAR(20) DEFAULT 'pending', -- pending/paid/refunded/cancelled
    
    -- 金额信息
    order_amount DECIMAL(16,2),
    paid_amount DECIMAL(16,2),
    
    -- 详细数据
    payment_detail JSONB NOT NULL,
    
    -- 时间
    order_time TIMESTAMP,
    payment_time TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.6 信息采集业务表（1张）
```sql
-- 信息采集业务表（覆盖信息采集相关的25个接口）
CREATE TABLE information_collection_business (
    id BIGSERIAL PRIMARY KEY,
    operation_log_id BIGINT REFERENCES business_operation_logs(id),
    
    -- 采集基本信息
    collection_id VARCHAR(100) NOT NULL UNIQUE,
    collection_type VARCHAR(50) NOT NULL, -- settlement_list/medical_record/clinical_data
    collection_action VARCHAR(20) NOT NULL, -- upload/query/modify/delete
    
    -- 关键业务字段
    psn_no VARCHAR(50),
    mdtrt_id VARCHAR(50),
    
    -- 采集状态
    collection_status VARCHAR(20) DEFAULT 'uploaded', -- uploaded/processed/failed
    
    -- 详细数据
    collection_detail JSONB NOT NULL,
    
    -- 时间
    collection_time TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 3. 接口与表的映射关系

### 3.1 核心表处理的接口（所有174个）
所有接口都会在 `business_operation_logs` 表中记录调用日志

### 3.2 专项表处理的接口

#### 结算业务表（17个接口）
- 2101-2103：药店结算相关
- 2201-2208：门诊结算相关
- 2301-2305：住院结算相关

#### 备案业务表（7个接口）
- 2501-2507：各种备案相关接口

#### 住院业务表（5个接口）
- 2401-2405：住院办理相关接口

#### 电子处方业务表（20个接口）
- 7101-7109：医疗机构电子处方
- 7201-7211：医药机构电子处方

#### 线上支付业务表（8个接口）
- 6101：医保电子凭证
- 6201-6204：订单支付
- 6301-6302：订单查询
- 6401：订单撤销

#### 信息采集业务表（25个接口）
- 4101-4105：结算清单
- 4261-4263：自费病人费用
- 4301-4302：门急诊业务
- 4401-4402A：住院业务
- 4501-4512：临床辅助业务
- 4601-4602：医疗管理业务
- 4701：电子病历
- 4901-4902,4905,5501：电子票据

### 3.3 仅记录在核心表的接口（约90个）
- 所有查询类接口（5201-5206, 5301-5304, 5401-5402,5461等）
- 异地就医购药相关接口（2161,2163,2166等）
- 明细审核接口（3101-3103）
- 分组付费接口（3601-3611）
- 申诉合议接口（3701-3704）
- 场景监控接口（9601-9605）
- 其他业务接口（9001-9002,9101-9102）
- 冲正交易接口（2601）

## 4. 使用示例

### 4.1 记录门诊结算操作
```sql
-- 1. 记录到核心日志表
INSERT INTO business_operation_logs (
    operation_id, api_code, api_name, business_category, business_type,
    institution_code, psn_no, mdtrt_id, request_data, response_data
) VALUES (
    'OP20250101001', '2207', '门诊结算', '结算业务', 'outpatient',
    'H12345678', 'P12345678', 'MDT001', 
    '{"mdtrt_id":"MDT001","psn_no":"P12345678"}',
    '{"setl_id":"SET001","fund_pay_sumamt":120.00}'
);

-- 2. 记录到结算业务表
INSERT INTO settlement_business (
    operation_log_id, settlement_id, settlement_type, settlement_subtype,
    mdtrt_id, psn_no, medfee_sumamt, fund_pay_sumamt, settlement_detail
) VALUES (
    1, 'SET001', 'outpatient', 'settlement',
    'MDT001', 'P12345678', 150.00, 120.00,
    '{"详细结算信息":"..."}'
);
```

### 4.2 记录慢特病备案操作
```sql
-- 1. 记录到核心日志表
INSERT INTO business_operation_logs (
    operation_id, api_code, api_name, business_category, business_type,
    institution_code, psn_no, request_data, response_data
) VALUES (
    'REG20250101001', '2503', '人员慢特病备案', '备案业务', 'chronic_disease',
    'H12345678', 'P12345678',
    '{"psn_no":"P12345678","opsp_dise_codg":"E11.9"}',
    '{"trt_dcla_detl_sn":"TRT001","备案状态":"待审核"}'
);

-- 2. 记录到备案业务表
INSERT INTO registration_business (
    operation_log_id, registration_id, registration_type, registration_action,
    psn_no, registration_status, registration_detail
) VALUES (
    2, 'REG001', 'chronic_disease', 'register',
    'P12345678', 'pending',
    '{"opsp_dise_codg":"E11.9","opsp_dise_name":"糖尿病"}'
);
```

## 5. 优势总结

### 5.1 表数量控制
- 用**8张表**处理**174个接口**
- 相比每个接口一张表，大大减少了表数量

### 5.2 设计优势
- **统一日志**：所有操作都有完整的调用记录
- **业务分离**：有状态的业务单独管理
- **灵活存储**：JSON字段适应不同接口结构
- **易于维护**：新接口只需要配置，无需建表

### 5.3 查询便利
- 可以统一查询所有接口的调用情况
- 可以针对特定业务查询状态和流转
- 支持按时间、机构、人员等多维度查询

这个方案既控制了表数量，又保持了业务的灵活性，您觉得如何？