# 优化的医保接口架构设计

## 整体架构流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   医院HIS   │───▶│  函数调用   │───▶│  Python脚本 │───▶│    SDK      │───▶│  医保接口   │
│   系统      │    │   脚本      │    │   中间件    │    │  通信层     │    │   服务器    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       ▲                                      │                                      │
       │                                      ▼                                      │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐            │
│  业务处理   │◀───│  读取视图   │◀───│  存储到视图 │◀───│  响应处理   │◀───────────┘
│   逻辑      │    │   数据      │    │   /数据库   │    │   脚本      │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 1. 各层职责划分

### 1.1 医院HIS系统
```sql
-- HIS只需要调用存储过程或函数
EXEC sp_medical_insurance_call 
    @interface_code = '1101',
    @input_data = '{"psn_no": "430123199001011234"}',
    @result_id = @result_id OUTPUT;

-- 然后查询结果视图
SELECT * FROM v_medical_insurance_result WHERE result_id = @result_id;
```

### 1.2 函数调用脚本（存储过程/函数）
```sql
CREATE PROCEDURE sp_medical_insurance_call
    @interface_code VARCHAR(10),
    @input_data NVARCHAR(MAX),
    @result_id INT OUTPUT
AS
BEGIN
    -- 1. 生成请求ID
    SET @result_id = NEXT VALUE FOR seq_request_id;
    
    -- 2. 插入请求记录
    INSERT INTO medical_insurance_requests (
        request_id, interface_code, input_data, 
        status, create_time
    ) VALUES (
        @result_id, @interface_code, @input_data, 
        'PENDING', GETDATE()
    );
    
    -- 3. 调用Python脚本
    DECLARE @cmd NVARCHAR(1000);
    SET @cmd = 'python C:\MedicalInsurance\processor.py ' + CAST(@result_id AS VARCHAR(10));
    EXEC xp_cmdshell @cmd;
END
```

### 1.3 Python中间件脚本
```python
# processor.py - 核心中间件
import sys
import json
import pyodbc
from medical_insurance_sdk import MedicalInsuranceClient

class MedicalInsuranceProcessor:
    def __init__(self):
        # 初始化SDK
        self.sdk_client = MedicalInsuranceClient(
            app_id="H12345678901_APP",
            app_secret="your_secret_key",
            org_code="H12345678901",
            base_url="https://api.hnybj.com"
        )
        
        # 数据库连接
        self.db_conn = pyodbc.connect(
            'DRIVER={SQL Server};SERVER=localhost;DATABASE=HIS;Trusted_Connection=yes;'
        )
    
    def process_request(self, request_id: int):
        """处理医保接口请求"""
        try:
            # 1. 从数据库读取请求信息
            request_info = self.get_request_info(request_id)
            
            # 2. 调用SDK发送请求
            response = self.sdk_client.call(
                request_info['interface_code'],
                json.loads(request_info['input_data'])
            )
            
            # 3. 保存响应到数据库
            self.save_response(request_id, response)
            
            # 4. 更新请求状态
            self.update_request_status(request_id, 'COMPLETED')
            
        except Exception as e:
            # 保存错误信息
            self.save_error(request_id, str(e))
            self.update_request_status(request_id, 'ERROR')
    
    def get_request_info(self, request_id: int):
        """获取请求信息"""
        cursor = self.db_conn.cursor()
        cursor.execute("""
            SELECT interface_code, input_data 
            FROM medical_insurance_requests 
            WHERE request_id = ?
        """, request_id)
        
        row = cursor.fetchone()
        return {
            'interface_code': row[0],
            'input_data': row[1]
        }
    
    def save_response(self, request_id: int, response: dict):
        """保存响应数据"""
        cursor = self.db_conn.cursor()
        cursor.execute("""
            INSERT INTO medical_insurance_responses 
            (request_id, response_data, infcode, err_msg, create_time)
            VALUES (?, ?, ?, ?, GETDATE())
        """, (
            request_id,
            json.dumps(response, ensure_ascii=False),
            response.get('infcode', ''),
            response.get('err_msg', '')
        ))
        self.db_conn.commit()

if __name__ == "__main__":
    request_id = int(sys.argv[1])
    processor = MedicalInsuranceProcessor()
    processor.process_request(request_id)
```

### 1.4 SDK通信层
```python
# medical_insurance_sdk/client.py
class MedicalInsuranceClient:
    def call(self, interface_code: str, data: dict) -> dict:
        """统一接口调用"""
        try:
            # 构建请求
            request_data = self._build_request(interface_code, data)
            
            # 发送HTTP请求
            response = self.session.post(
                f"{self.base_url}/api/medical-insurance",
                json=request_data,
                timeout=self.timeout
            )
            
            # 处理响应
            return self._handle_response(response.json())
            
        except Exception as e:
            return {
                "infcode": "-1",
                "err_msg": f"SDK调用异常: {str(e)}"
            }
```

## 2. 数据库表结构设计

### 2.1 请求表
```sql
CREATE TABLE medical_insurance_requests (
    request_id INT PRIMARY KEY,
    interface_code VARCHAR(10) NOT NULL,
    input_data NVARCHAR(MAX) NOT NULL,
    status VARCHAR(20) NOT NULL, -- PENDING, PROCESSING, COMPLETED, ERROR
    create_time DATETIME NOT NULL,
    update_time DATETIME,
    INDEX idx_status_time (status, create_time)
);
```

### 2.2 响应表
```sql
CREATE TABLE medical_insurance_responses (
    response_id INT IDENTITY(1,1) PRIMARY KEY,
    request_id INT NOT NULL,
    response_data NVARCHAR(MAX) NOT NULL,
    infcode VARCHAR(10),
    err_msg NVARCHAR(500),
    create_time DATETIME NOT NULL,
    FOREIGN KEY (request_id) REFERENCES medical_insurance_requests(request_id)
);
```

### 2.3 结果视图
```sql
CREATE VIEW v_medical_insurance_result AS
SELECT 
    r.request_id,
    r.interface_code,
    r.input_data,
    r.status,
    r.create_time as request_time,
    resp.response_data,
    resp.infcode,
    resp.err_msg,
    resp.create_time as response_time,
    CASE 
        WHEN r.status = 'COMPLETED' AND resp.infcode = '0' THEN 'SUCCESS'
        WHEN r.status = 'COMPLETED' AND resp.infcode != '0' THEN 'BUSINESS_ERROR'
        WHEN r.status = 'ERROR' THEN 'SYSTEM_ERROR'
        ELSE 'PROCESSING'
    END as result_status
FROM medical_insurance_requests r
LEFT JOIN medical_insurance_responses resp ON r.request_id = resp.request_id;
```

## 3. 具体使用示例

### 3.1 HIS系统调用人员信息查询
```sql
-- HIS系统代码
DECLARE @result_id INT;
DECLARE @patient_id VARCHAR(18) = '430123199001011234';

-- 调用医保接口
EXEC sp_medical_insurance_call 
    @interface_code = '1101',
    @input_data = '{"psn_no": "430123199001011234"}',
    @result_id = @result_id OUTPUT;

-- 等待处理完成（可以轮询或设置延时）
WAITFOR DELAY '00:00:02';

-- 查询结果
SELECT 
    result_status,
    response_data,
    err_msg
FROM v_medical_insurance_result 
WHERE request_id = @result_id;

-- 如果成功，解析响应数据
IF EXISTS (SELECT 1 FROM v_medical_insurance_result 
           WHERE request_id = @result_id AND result_status = 'SUCCESS')
BEGIN
    -- 可以进一步解析JSON数据
    DECLARE @response_json NVARCHAR(MAX);
    SELECT @response_json = response_data 
    FROM v_medical_insurance_result 
    WHERE request_id = @result_id;
    
    -- 使用JSON函数解析（SQL Server 2016+）
    SELECT 
        JSON_VALUE(@response_json, '$.output.baseinfo.psn_name') as patient_name,
        JSON_VALUE(@response_json, '$.output.baseinfo.gend') as gender,
        JSON_VALUE(@response_json, '$.output.baseinfo.brdy') as birthday
END
```

### 3.2 HIS系统调用门诊结算
```sql
-- 门诊结算流程
DECLARE @settle_result_id INT;

EXEC sp_medical_insurance_call 
    @interface_code = '2207',
    @input_data = '{
        "mdtrt_id": "H1234567890120241201001",
        "psn_no": "430123199001011234",
        "chrg_bchno": "20241201001",
        "acct_used_flag": "0",
        "insutype": "310",
        "invono": "INV20241201001"
    }',
    @result_id = @settle_result_id OUTPUT;

-- 查询结算结果
SELECT * FROM v_medical_insurance_result WHERE request_id = @settle_result_id;
```

## 4. 错误处理和监控

### 4.1 错误处理机制
```python
# processor.py 中的错误处理
def process_request_with_retry(self, request_id: int, max_retries: int = 3):
    """带重试的请求处理"""
    for attempt in range(max_retries):
        try:
            self.process_request(request_id)
            return
        except NetworkException as e:
            if attempt < max_retries - 1:
                time.sleep(2 ** attempt)  # 指数退避
                continue
            else:
                self.save_error(request_id, f"网络异常，重试{max_retries}次后失败: {str(e)}")
        except Exception as e:
            self.save_error(request_id, f"系统异常: {str(e)}")
            break
```

### 4.2 监控视图
```sql
-- 监控统计视图
CREATE VIEW v_medical_insurance_monitor AS
SELECT 
    interface_code,
    COUNT(*) as total_requests,
    SUM(CASE WHEN result_status = 'SUCCESS' THEN 1 ELSE 0 END) as success_count,
    SUM(CASE WHEN result_status = 'BUSINESS_ERROR' THEN 1 ELSE 0 END) as business_error_count,
    SUM(CASE WHEN result_status = 'SYSTEM_ERROR' THEN 1 ELSE 0 END) as system_error_count,
    AVG(DATEDIFF(SECOND, request_time, response_time)) as avg_response_time_seconds
FROM v_medical_insurance_result
WHERE request_time >= DATEADD(DAY, -1, GETDATE())
GROUP BY interface_code;
```

## 5. 部署和配置

### 5.1 目录结构
```
C:\MedicalInsurance\
├── processor.py              # 主处理脚本
├── config.json              # 配置文件
├── logs\                    # 日志目录
├── medical_insurance_sdk\   # SDK包
└── requirements.txt         # Python依赖
```

### 5.2 配置文件
```json
{
    "sdk": {
        "app_id": "H12345678901_APP",
        "app_secret": "your_secret_key",
        "org_code": "H12345678901",
        "base_url": "https://api.hnybj.com",
        "timeout": 30
    },
    "database": {
        "connection_string": "DRIVER={SQL Server};SERVER=localhost;DATABASE=HIS;Trusted_Connection=yes;"
    },
    "logging": {
        "level": "INFO",
        "file": "logs/processor.log"
    }
}
```

## 6. 优势总结

### 6.1 架构优势
1. **解耦合**：HIS系统与医保接口完全解耦
2. **异步处理**：不阻塞HIS主流程
3. **可监控**：完整的请求响应记录
4. **易维护**：各层职责清晰
5. **可扩展**：支持所有医保接口

### 6.2 技术优势
1. **数据持久化**：所有交互数据都有记录
2. **错误恢复**：支持重试和错误处理
3. **性能监控**：可以统计接口调用情况
4. **调试友好**：可以查看完整的请求响应链路

这个架构设计既保持了HIS系统的简洁性，又提供了强大的医保接口集成能力。你觉得这个设计如何？需要我详细展开某个部分吗？